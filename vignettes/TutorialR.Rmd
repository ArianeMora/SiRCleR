---
title: "SiRCle tutorial R"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{SiRCle tutorial R}
  %\VignetteEncoding{UTF-8}
---

## First create an environment 

Note if your computer has an old version of python (i.e. < 3.8) the machine learning might not work, so would recommend installing anaconda, look into reticulate for more details.

https://rstudio.github.io/reticulate/articles/versions.html
```{r}
# install.packages("reticulate)
library("reticulate")
virtualenv_create(
      envname = "scircm",
      python = NULL,
      packages = "scircm",
      system_site_packages = getOption("reticulate.virtualenv.system_site_packages",
                                       default = FALSE)
    )

```
## Install the R package

```{r}
#install.packages("devtools")
library(devtools)
install_github("ArianeMora/SiRCleR")
library(sircle)
```

### SiRCle tutorial in R

Note we assume your methylation CpGs map to a single gene, if they don't  you'll need to filter them.

```{r}
library(basilisk)
data_dir <- '/Users/ariane/Documents/code/scircm/examples/data/data_example/'

protFile <- paste0(data_dir, 'prot_DE_Stage IV_sircle.csv')
rnaFile <- paste0(data_dir, 'rna_DE_Stage IV_sircle_renamed-cols.csv')
methFile <- paste0(data_dir, 'filtered_cpg_DE_Stage IV_sircle.csv')
geneId <- 'ensembl_gene_id'

sircleFileName <- "SircleR-RCM.csv"
bas_scircm <- BasiliskEnvironment(envname="bas_scircm",
                                   pkgname="sircle",
                                   packages=c("numpy==1.20"),
                                  pip=c("scircm==1.0.1")
)

sircleRCM <- function(rnaFile, methFile, proteinFile, geneId,
                      rnaValueCol, rnaPadjCol, methValueCol, methPadjCol, proteinValueCol, proteinPadjCol, proteinCols=NULL,
                      rnaPadjCutoff=0.05, rnaLogFCCutoff=0.5, proteinPadjCutoff=0.05, proteinValueCutoff=0.3,
                      methPadjCutoff=0.05, methDiffCutoff=10, backgroundMethod="P|(M&R)", fileSep=",",
                      nonCodingGeneList=NULL, outputFileName="SiRCle_RCM.csv", 
                      logfile="logfileRCM.csv", envName=NULL, condaEnvName=NULL, envPath=NULL) {
  setupEnv = F
  ## ------------ Setup and installs ----------- ##
  packages <- c("tidyverse", "reticulate", "dplyr")
  install.packages(setdiff(packages, rownames(installed.packages())))
  
  library(tidyverse)
  library(dplyr)
  library(reticulate)
  
  scimotf <<- import("scimotf")  # Make global
  scircm <<- import("scircm")    # Make global
  scivae <<- import("scivae")    # Make global
  
  ## ------------ Run the RCM ----------- ##
  rcm <- scircm$SciRCM(methFile, rnaFile, proteinFile,
                       rnaValueCol, rnaPadjCol, methValueCol, methPadjCol,
                       proteinValueCol, proteinPadjCol, geneId, sep=fileSep,
                       rna_padj_cutoff=rnaPadjCutoff, prot_padj_cutoff=proteinPadjCutoff, meth_padj_cutoff=methPadjCutoff,
                       rna_logfc_cutoff=rnaLogFCCutoff, prot_logfc_cutoff=proteinValueCutoff, meth_diff_cutoff=methDiffCutoff,
                       non_coding_genes=nonCodingGeneList, bg_type=backgroundMethod, logfile=logfile
  )
  # Check if the user wants to impute the protein columns
  rcm$run()
  df <- rcm$get_df()
  # This changes it so we can use it in R again
  rcm$save_df(outputFileName)
  
  return(rcm)
}

res <- basiliskRun(env=bas_scircm, fun=function(args) {
    rcm <- sircleRCM(rnaFile, methFile, protFile, geneId,  "logFC_rna", "padj_rna", "CpG_Beta_diff", "padj_meth", "logFC_protein", "padj_protein",
                 outputFileName = sircleFileName, 
                 envName="scircm")
    # Do something with pandas
    return(rcm)
})


#logFC_rna = column name in your RNA file that has your RNA logFC (same for the protein and CpG)
#padj_rna = column name in your RNA file that has your padj value (same for protein and CpG)
#NOTE: these need to be unique from one another since we merge the datasets, if they aren't, you need
#to update your csv files.
#Lastly: ensembl_gene_id this is the gene ID column, All must use the same identifier, and this must be
#labelled the same in each file, if it isn't, update your column names before running.

# Run the sircle RCM this may take some time
rcm <- sircleRCM(rnaFile, methFile, protFile, geneId,  "logFC_rna", "padj_rna", "CpG_Beta_diff", "padj_meth", "logFC_protein", "padj_protein",
                 outputFileName = sircleFileName, 
                 envName="scircm")

# Plot the sircle function
sirclePlot(sircleFileName, regLabels="Regulation_Grouping_2") 

# Run ORA on the groups
sircleORAHuman(sircleFileName, "entrezgene_id", "Regulation_Grouping_2")


```
## Now you have the regulatory clusters you can perform comparisons between groups

Here we train (or load from saved) a VAE and then perform a comparison on two groups of patients.


```{r}

makeSircleStatModel <- function(rcmFile, patientSampleFile, 
                                methFile, methSampleFile, rnaFile, rnaSampleFile, proteinFile, proteinSampleFile,
                                sampleLabelColumn, conditionColumn, patientIdColumn, configVAEFile, RegulatoryLabel, fromSaved=F, casesForTraining=NULL,
                                outputFolder="", runName="VAE", normalise="rows",
                                missingMethod="mean", verbose=T, outputFileName="SiRCle_RCM.csv", 
                                logfile="logfileRCM.csv", envName=NULL, condaEnvName=NULL, envPath=NULL) {
  setupEnv = F
  ## ------------ Setup and installs ----------- ##
  packages <- c("tidyverse", "reticulate", "dplyr")
  install.packages(setdiff(packages, rownames(installed.packages())))
  
  library(tidyverse)
  library(dplyr)
  library(reticulate)
  scircm <<- import("scircm")    # Make global
  
  ## ------------ Run the RCM Stats ----------- ##
  sv <- scircm$RCMStats(rcmFile,
                        patientSampleFile, 
                        methFile, 
                        methSampleFile,
                        rnaFile, 
                        rnaSampleFile, 
                        proteinFile, 
                        proteinSampleFile,
                        outputFolder,
                        conditionColumn, 
                        sampleLabelColumn,
                        patientIdColumn, 
                        configVAEFile, RegulatoryLabel,
                        runName, normalise, verbose, missingMethod)
  
  if (fromSaved) {
    ## ------------ Re-load saved VAEs ----------- ##
    sv$load_saved_vaes()
    sv$load_saved_encodings(paste0(sv$output_folder, 'encoded_df_', sv$run_name, '.csv'))
    sv$load_saved_inputs(paste0(sv$output_folder, 'vae_input_df_', sv$run_name, '.csv'))
    sv$load_saved_raws(paste0(sv$output_folder, 'raw_input_df_', sv$run_name, '.csv'))
  } else {
    sv$train_vae(casesForTraining) #ToDo: allow users to set their own config. cases=matching_cases, config=config)
    sv$save()  # Save the information we have generated.
  }
  
  return(sv)
}


```

```{r}
# VAE on two groups

rcmFile <- paste0(data_dir, 'RCM.csv')

rcm_df <- read.csv(rcmFile)
rcm_df <- rcm_df[, 2:ncol(rcm_df)]  # Need to have the ensembl gene ID as the first column
write.csv(rcm_df, sircleFileName, row.names=FALSE)

proteinSampleFile <- paste0(data_dir, "prot_sample_data_Stage IV_sircle.csv")
methSampleFile <- paste0(data_dir, "cpg_sample_data_Stage IV_sircle.csv")
rnaSampleFile <- paste0(data_dir, "rna_sample_data_Stage IV_sircle.csv")
patientSampleFile <- paste0(data_dir, "clinical_CPTAC_TCGA.csv") # Should include all patients

# We need to get the columns we're interested from the RCM file for each 
# this is just also so we can look at the CSV files separately.
proteinSamples <- read.csv(proteinSampleFile)
rnaSamples <- read.csv(rnaSampleFile)
methSamples <- read.csv(methSampleFile)

# Save each output to a csv file 
proteinFile <- paste0(data_dir, 'CPTAC_protein_S4.csv')
methFile <- paste0(data_dir, 'CPTAC_cpg_S4.csv')
rnaFile <- paste0(data_dir, 'CPTAC_RNA_S4.csv')

# Again need to have the ensembl gene ID as the first column
#write.csv(rcm_df[, c(geneId, proteinSamples$FullLabel)],  paste0(data_dir, 'CPTAC_protein_S4.csv'), row.names=FALSE)
#write.csv(rcm_df[, c(geneId, methSamples$FullLabel)], paste0(data_dir, 'CPTAC_cpg_S4.csv'), row.names=FALSE)
#write.csv(rcm_df[, c(geneId, rnaSamples$FullLabel)], paste0(data_dir, 'CPTAC_RNA_S4.csv'), row.names=FALSE)

sampleLabelColumn <- "FullLabel"
conditionColumn <- "CondId"
patientIdColumn <- "SafeCases"
RegulatoryLabel <- "Regulation_Grouping_2"

casesForTraining <- c('C3L.00011', 'C3L.00096', 'C3L.01287', 'C3N.00149', 'C3N.00150',
       'C3N.00194', 'C3N.00390', 'C3N.01200', 'C3N.01220')

# Training
res_sv <- basiliskRun(env=bas_scircm, fun=function(args) {
    sv <- makeSircleStatModel(rcmFile, patientSampleFile, methFile, methSampleFile, rnaFile, rnaSampleFile, proteinFile, proteinSampleFile, sampleLabelColumn, conditionColumn, patientIdColumn, NULL, RegulatoryLabel, fromSaved=F, casesForTraining=casesForTraining, outputFolder=data_dir, envName="scircm", runName="Rversion")
    # Do something with pandas
    return(sv)
})

df <- res_sv$run_vae_stats("gender", "Female", "Male")
df <- as.data.frame(df)
  
sv <- makeSircleStatModel(rcmFile, patientSampleFile, methFile, methSampleFile, rnaFile, rnaSampleFile, proteinFile, proteinSampleFile, sampleLabelColumn, conditionColumn, patientIdColumn, NULL, RegulatoryLabel, fromSaved=F, casesForTraining=casesForTraining, outputFolder=data_dir, envName="scircm", runName="Rversion")

# Loading a saved version (just changed the fromSaved flag)
sv <- makeSircleStatModel(rcmFile, patientSampleFile, methFile, methSampleFile, rnaFile, rnaSampleFile, proteinFile, proteinSampleFile, sampleLabelColumn, conditionColumn, patientIdColumn, NULL, RegulatoryLabel, fromSaved=T, casesForTraining=casesForTraining, outputFolder=data_dir, envName="scircm", runName="Rversion")

# Now you can run stats
statsDf <- runSircleStats(sv, "gender", "Female", "Male")
statsDf[statsDf['Integrated pval (Male-Female)'] < 0.05] # E.g we can look at things now

```

### TF analysis using Dorothea

```{r}
# TF analysis
doroFile <- paste0(data_dir, 'dorothea_hs_ABCD.csv')
TFPadjCol <- 'padj_rna'
TFValueCol <- 'logFC_rna'
TargetPadjCol <- 'padj_rna'
TargetValueCol <- 'logFC_rna'
sircleRCMFilename <- paste0(data_dir, 'RCM.csv')
outputDir <- data_dir
clusterGeneId <- "external_gene_name" # This has to match the gene names in doro file
m_df <- sircleMotif(clusterGeneId, doroFile, sircleRCMFilename, TFPadjCol, TFValueCol, TargetPadjCol, TargetValueCol, "Regulation_Grouping_2",
                     doroLevel=c("A"), clusters=c("TMDE", "TMDS", "MDS", "MDE", "TPDE", "TPDS"), TFInDataset=F, outputDir=data_dir, plotOn=T)


class TestRCMVAE(TestClass):

    def test_new_stats(self):
        base_dir = '../examples/data/'
        output_dir = f'{base_dir}'
        data_dir = f'{base_dir}'
        rcm_file = f'{data_dir}RCM.csv'
        # Now we want to check stats where we use the data that accomnaied those inputs
        label = 'FINAL'

        meth_file = f'{data_dir}CPTAC_cpg.csv'
        rna_file = f'{data_dir}CPTAC_rna.csv'
        protein_file = f'{data_dir}CPTAC_protein.csv'

        meth_sample_file = f'{data_dir}cpg_sample_data_Stage IV_sircle.csv'
        rna_sample_file = f'{data_dir}rna_sample_data_Stage IV_sircle.csv'
        protein_sample_file = f'{data_dir}prot_sample_data_Stage IV_sircle.csv'
        sv = RCMStats(rcm_file, f'{data_dir}clinical_CPTAC_TCGA.csv',
                    meth_file, meth_sample_file, rna_file, rna_sample_file,
                    protein_file, protein_sample_file,
                      output_folder=output_dir, column_id='FullLabel',
                      condition_column='CondId',
                       patient_id_column='SafeCases',
                       run_name=label,
                        normalise='rows', missing_method='clinical', iid=True)
        epochs = 2  # To make it quicker to train
        batch_size = 16
        num_nodes = 5
        mmd_weight = 0.25
        loss = {'loss_type': 'mse', 'distance_metric': 'mmd', 'mmd_weight': mmd_weight}
        config = {"loss": loss,
                  "encoding": {"layers": [{"num_nodes": num_nodes, "activation_fn": "relu"}]},
                  "decoding": {"layers": [{"num_nodes": num_nodes, "activation_fn": "relu"}]},
                  "latent": {"num_nodes": 1},
                  "optimiser": {"params": {'learning_rate': 0.01}, "name": "adam"},
                  "epochs": epochs,
                  "batch_size": batch_size,
                  "scale_data": False
                  }
        training_cases = ['C3L.00004', 'C3L.00010', 'C3L.00011', 'C3L.00026', 'C3L.00079', 'C3L.00088', 'C3L.00096',
                          'C3L.00097', 'C3L.00103', 'C3L.00360', 'C3L.00369', 'C3L.00416', 'C3L.00418', 'C3L.00447',
                          'C3L.00581', 'C3L.00606', 'C3L.00814', 'C3L.00902', 'C3L.00907', 'C3L.00908', 'C3L.00910',
                          'C3L.00917', 'C3L.01286', 'C3L.01287', 'C3L.01313', 'C3L.01603', 'C3L.01607', 'C3L.01836',
                          'C3N.00148', 'C3N.00149', 'C3N.00150', 'C3N.00177', 'C3N.00194', 'C3N.00244', 'C3N.00310',
                          'C3N.00314', 'C3N.00390', 'C3N.00494', 'C3N.00495', 'C3N.00573', 'C3N.00577', 'C3N.00646',
                          'C3N.00733', 'C3N.00831', 'C3N.00834', 'C3N.00852', 'C3N.01176', 'C3N.01178', 'C3N.01179',
                          'C3N.01200', 'C3N.01214', 'C3N.01220', 'C3N.01261', 'C3N.01361', 'C3N.01522', 'C3N.01646',
                          'C3N.01649', 'C3N.01651', 'C3N.01808']
        sv.train_vae(cases=training_cases, config=config)
        sv.save()
        #sv.load_saved_vaes()
        #sv.load_saved_inputs(f'{output_dir}input_df_{label}.csv')
        #sv.load_saved_encodings(f'{output_dir}encoded_df_{label}.csv')
        sv.run_vae_stats(cond_label='gender', cond0='Male', cond1='Female')
        #sv.run_vae_stats(cond_label='AgeGrouped', cond0='young', cond1='old')
        #sv.run_vae_stats(cond_label='TumorStage', cond0='Stage I', cond1='Stage IV')
        dec = sv.get_decoding('MDS')
        print(dec)

```


